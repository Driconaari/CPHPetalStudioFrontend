<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOMContentLoaded event fired');

        fetch('http://localhost:8080/api/bouquets')
            .then(response => {
                console.log('Fetch bouquets response:', response);
                return response.json();
            })
            .then(data => {
                console.log('Bouquets data:', data);
                const bouquetList = document.getElementById('bouquet-list');
                bouquetList.innerHTML = '';
                data.forEach(bouquet => {
                    console.log('Processing bouquet:', bouquet);
                    bouquetList.innerHTML += `
                        <div class="col-md-4 mb-4">
                            <div class="card product-card position-relative">
                                ${bouquet.featured ? '<span class="most-popular">Most Popular</span>' : ''}
                                <img src="${bouquet.imageUrl}" class="card-img-top" alt="${bouquet.name}">
                                <div class="card-body">
                                    <h5 class="card-title">${bouquet.name}</h5>
                                    <p class="card-text">${bouquet.description}</p>
                                    <p class="card-text text-success">$${bouquet.price.toFixed(2)}</p>
                                    <button class="btn btn-primary add-to-cart" data-id="${bouquet.id}">Add to Cart</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            })
            .catch(error => console.error('Error fetching bouquets:', error));

        document.addEventListener('click', function (event) {
            console.log('Click event:', event);
            if (event.target && event.target.classList.contains('add-to-cart')) {
                event.preventDefault();
                const bouquetId = event.target.getAttribute('data-id');
                console.log('Add to cart clicked, bouquetId:', bouquetId);
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    console.error('JWT token not found in localStorage');
                    alert('You must be logged in to add items to the cart.');
                    return;
                }
                console.log('JWT token:', token);
                fetch('http://localhost:8080/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ bouquetId, quantity: 1 })
                })
                    .then(response => {
                        console.log('Add to cart response:', response);
                        if (!response.ok) {
                            if (response.status === 403) {
                                throw new Error('You do not have permission to add items to the cart.');
                            } else if (response.status === 401) {
                                throw new Error('You must be logged in to add items to the cart.');
                            } else {
                                throw new Error('Network response was not ok');
                            }
                        }
                        return response.text(); // Read the response as text
                    })
                    .then(text => {
                        console.log('Add to cart response text:', text);
                        if (text) {
                            return JSON.parse(text); // Parse the text as JSON if it's not empty
                        } else {
                            throw new Error('Empty response');
                        }
                    })
                    .then(data => {
                        console.log('Add to cart data:', data);
                        const successMessage = document.getElementById('success-message');
                        if (successMessage) {
                            successMessage.style.display = 'block';
                            setTimeout(() => {
                                successMessage.style.display = 'none';
                            }, 3000);
                        }
                        updateCartCount();
                    })
                    .catch(error => {
                        console.error('Error adding item to cart:', error.message);
                        alert('Error adding item to cart: ' + error.message);
                    });
            }
        });

        function updateCartCount() {
            console.log('Updating cart count');
            fetch('http://localhost:8080/shop/cart/count', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('jwt_token')
                }
            })
                .then(response => {
                    console.log('Cart count response:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('Cart count data:', data);
                    const cartCountElement = document.querySelector('.cart-count');
                    if (cartCountElement) {
                        cartCountElement.textContent = data.count;
                    }
                })
                .catch(error => console.error('Error fetching cart count:', error));
        }
    });
</script>